# graphql-codegen をセットアップ

## 参考URL

<https://zenn.dev/layerx/articles/028cb518cffd61>
<https://nhost.io/blog/how-to-use-graphql-code-generator-with-react-and-apollo>
<https://zenn.dev/optimisuke/articles/8de632308cebeb>
<https://zenn.dev/sky/articles/47b86d3387389d>
<https://zenn.dev/buyselltech/articles/b64935ea7d6fee>

## ステップ

apps/web に graphql-codegen の出力ファイル を保存する方法とする。

### 1. パッケージを追加

- パッケージ追加

```bash
npm -w apps/web i graphql-request
```

- graphql-codegen/graphql-request用に下記パッケージも必要  

```bash
npm i @graphql-codegen/cli @graphql-codegen/client-preset
```

### 2. codegen.ts を作成

`tools/graphql-codegen/codegen.ts`

```ts
import type { CodegenConfig } from '@graphql-codegen/cli';

const codegenConfig: CodegenConfig = {
  overwrite: true,
  schema: 'apps/api/dist/autogenerated-schema.gql',
  documents: ['apps/web/src/**/*.ts', 'apps/web/src/**/*.tsx'],
  generates: {
    'apps/web/src/gql/': {
      preset: 'client',
      plugins: [],
      config: {},
    },
  },
};

export default codegenConfig;
```

### 3. コード生成用のスクリプトを追加

`package.json`

```json
"scripts": {
    ...,
    "----START----": "-------------------------",
    "start:gql": "graphql-codegen --config tools/graphql-codegen/codegen.ts --watch",
    ...,
```

turbo で cache を利用しないように設定しておくこと。  

`turbo.json`

```json
    "start:gql": {
      "cache": false
    },
```

スクリプト実行により、コードを自動生成する。

```bash
npm run start:gql
```

### 4. getGraphqlClient を作成

`apps/web/src/lib/graphql-client.ts`

```ts
import { webEnv } from '@/config/web-env';
import { GraphQLClient } from 'graphql-request';

if (!webEnv.NEXT_PUBLIC_API_GQL_URL) {
  throw new Error('env: NEXT_PUBLIC_API_GQL_URL is not defined');
}

const getGraphQLClient = (url: string) => {
  return new GraphQLClient(url, {
    credentials: 'include',
  });
};

export const gql: ReturnType<typeof getGraphQLClient> = getGraphQLClient(
  webEnv.NEXT_PUBLIC_API_GQL_URL,
);
```

## 利用例

e.g. Nextjs. page コンポーネント

```ts
'use client';

import { graphql } from '@/gql';
import { gql } from '@/lib/graphql-client';
import { useEffect } from 'react';

const queryExampleGql = graphql(`
  query queryExample {
    dummies {
      id
      text
      createdAt
      updatedAt
    }
  }
`);

const Page = () => {
  useEffect(() => {
    const fetch = async () => {
      const dummies = await gql.request(queryExampleGql);
      console.log(dummies);
    };

    fetch();
  });

  return <div>Graphqlのデータが、Consoleに出力されています。</div>;
};

export default Page;
```
