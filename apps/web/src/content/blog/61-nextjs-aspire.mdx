---
title: Next.js + ASP.NET Core + YARP ã‚’ .NET Aspire ã§æ§‹æˆã™ã‚‹
description: Next.js + ASP.NET Core + YARPï¼ˆReverse Proxyï¼‰ ã‚’ .NET Aspire ã§æ§‹æˆã™ã‚‹æ–¹æ³•
date: 2024-05-25
lastmod: 2024-05-25
emoji: ğŸ•·
tags: 
  - nextjs
  - aspnet
  - csharp
published: true
---

Next.jsã¨ASP.NET Coreã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€YARP (Yet Another Reverse Proxy) ã‚’åˆ©ç”¨ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’é€£æºã•ã›ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚ä¸»ãªæµã‚Œã¯ä¸‹è¨˜ã¨ãªã‚Šã¾ã™ã€‚

1. ASP.NET Coreã‚’ä½¿ç”¨ã—ã¦WebAPIã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
2. Next.jsã‚’ä½¿ç”¨ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
3. .NET Aspireã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã—ã€YARPã‚’ä½¿ç”¨ã—ã¦Reverse Proxyã‚’å®Ÿè£…ã™ã‚‹ã€‚
4. Next.jsã‹ã‚‰ASP.NET Core WebAPIã‚’å‘¼ã³å‡ºã™æ–¹æ³•ã‚’èª¬æ˜ã™ã‚‹ã€‚

è¨˜äº‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ (https://github.com/atman-33/nextjs-aspire)

## å‚è€ƒURL

è©³ç´°ãªæ‰‹é †ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ï¼š
[Next.js + ASP.NET Core ã‚’ .NET Aspire ã§æ§‹æˆã™ã‚‹ï¼ˆwith YARPï¼‰](https://qiita.com/takashiuesaka/items/e167852af299a7b00939)

> æ§‹ç¯‰æ‰‹é †ã¯ä¸Šè¨˜ã‚µã‚¤ãƒˆã§è©³ç´°ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ãŒã€Next.jsã®CSRãƒšãƒ¼ã‚¸ã‹ã‚‰WebApiã‚’å©ã„ãŸå¾Œã®CORSã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œãªã‹ã£ãŸãŸã‚ã€ãã®ã‚¨ãƒ©ãƒ¼å¯¾å¿œã¨ã—ã¦æœ¬è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦é ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

## 1. WebAPIã‚’ASP.NET Coreã§ä½œæˆ

### ç©ºã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

ã¾ãšã€ç©ºã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³åã¯`NextJSAspire`ã¨ã—ã¾ã™ã€‚

![ç©ºã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³](/blog/61/image-0.1.png)

### ASP.NET COREã‚’ä½œæˆ

æ¬¡ã«ã€ASP.NET Core Web APIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯`WebApi`ã¨ã—ã¾ã™ã€‚

![ASP.NET Core Web API](/blog/61/image-1.png)

## 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’Next.jsã§ä½œæˆ

ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’PowerShellã§é–‹ãã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

- Next.jsç”Ÿæˆã‚³ãƒãƒ³ãƒ‰

```powershell
npx create-next-app@latest
```

- ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã®å„ç¨®è¨­å®šï¼ˆå‚è€ƒï¼‰

```powershell
PS C:\Repos\nextjs-aspire> npx create-next-app@latest
Need to install the following packages:
create-next-app@14.2.3
Ok to proceed? (y) y
âˆš What is your project named? ... frontend
âˆš Would you like to use TypeScript? ... Yes
âˆš Would you like to use ESLint? ... Yes
âˆš Would you like to use Tailwind CSS? ... Yes
âˆš Would you like to use `src/` directory? ... Yes
âˆš Would you like to use App Router? (recommended) ... Yes
âˆš Would you like to customize the default import alias (@/*)? ... Yes
âˆš What import alias would you like configured? ... @/*
Creating a new Next.js app in C:\Repos\nextjs-aspire\frontend.
```

## 3. Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’.NET Aspireç®¡ç†ã«ã™ã‚‹

Node.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’.NET Aspireã§ç®¡ç†ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‚ç…§ãŒå¿…è¦ã§ã™ã€‚AppHostãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œè¿½åŠ ã€â†’ã€Œ.NET Aspire ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ã‚’é¸æŠã—ã¾ã™ã€‚

![.NET Aspire Package](/blog/61/image-2.png)

è¡¨ç¤ºã•ã‚ŒãŸNuGetãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ç”»é¢ã§æ¤œç´¢æ–‡å­—åˆ—ã«ã€ŒNodeã€ã‚’è¿½åŠ ã—ã€Node.jsã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

![NuGet Package Manager](/blog/61/image-3.png)

AppHostãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Program.csã‚’æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```cs
using Microsoft.Extensions.Hosting;

var builder = DistributedApplication.CreateBuilder(args);

var api = builder.AddProject<Projects.WebApi>("webapi");

var frontend = builder.AddNpmApp(name: "frontend", workingDirectory: "../frontend", scriptName: "dev")
    .WithHttpEndpoint(env: "PORT")
    .WithExternalHttpEndpoints()
    .WithReference(api);

if (builder.Environment.IsDevelopment() && builder.Configuration["DOTNET_LAUNCH_PROFILE"] == "https")
{
    frontend.WithEnvironment("NODE_TLS_REJECT_UNAUTHORIZED", "0");
}

builder.Build().Run();
```

## 4. Next.jsã‹ã‚‰WebAPIã‚’å‘¼ã³å‡ºã™

### WebAPIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¤‰æ›´

Next.jsã®å®Ÿè£…å‰ã«ã€WebAPIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¤‰æ›´ã—ã¾ã™ã€‚WebAPIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Program.csã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```cs
var builder = WebApplication.CreateBuilder(args);

builder.AddServiceDefaults();

var app = builder.Build();

app.MapDefaultEndpoints();

app.UseHttpsRedirection();

var summaries = new[]
{
    "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
};

// app.MapGet("weatherforecast", () =>
app.MapGet("api/weatherforecast", () => // <= api/ ã‚’è¿½åŠ 
{
    var forecast = Enumerable.Range(1, 5).Select(index =>
        new WeatherForecast
        (
            DateOnly.FromDateTime(DateTime.Now.AddDays(index)),
            Random.Shared.Next(-20, 55),
            summaries[Random.Shared.Next(summaries.Length)]
        ))
        .ToArray();
    return forecast;
});

app.Run();

record WeatherForecast(DateOnly Date, int TemperatureC, string? Summary)
{
    public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);
}
```

### Server Componentsã‹ã‚‰WebAPIã‚’å‘¼ã³å‡ºã™

`frontend\src\app\server\page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
const getData = async () => {
    const apiServer = process.env['services__webapi__https__0'] ?? process.env['services__webapi__http__0'];
    const weatherData: Response = await fetch(`${apiServer}/api/weatherforecast`, { cache: 'no-cache' });

    if (!weatherData.ok) {
        throw new Error('Failed to fetch data.');
    }

    const data = await weatherData.json();
    return data;
}

const Page = async () => {
    const data = await getData();
    return <main>{JSON.stringify(data)}</main>;
}

export default Page;
```

### Client Componentsã‹ã‚‰WebAPIã‚’å‘¼ã³å‡ºã™

`frontend\src\app\client\page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
'use client'

import { useEffect, useState } from 'react';

const getData = async () => {
  // NOTE:  WebApi ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® launchSettings.json ãƒ•ã‚¡ã‚¤ãƒ« > profiles > http > applicationUrl
  // "applicationUrl": "http://localhost:5291",
  const weatherData: Response = await fetch('http://localhost:5291/api/weatherforecast', { cache: 'no-cache' });

  if (!weatherData.ok) {
    throw new Error('Failed to fetch data.');
  }

  const data = await weatherData.json();
  return data;
}

const ClientPage = () => {
  const [data, setData] = useState([]);

  useEffect(() => {
    getData().then((data) => setData(data));
  }, []);

  return <main>{JSON.stringify(data)}</main>;
}

export default ClientPage;
```

ã“ã®æ™‚ç‚¹ã§ã¯ã€CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§Reverse Proxyã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 5. YARPã§Reverse Proxyã‚’å®Ÿè£…ã™ã‚‹

### ç©ºã®ASP.NET Coreã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹

ASP.NET Coreï¼ˆç©ºï¼‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯`ReverseProxy`ã¨ã—ã¾ã™ã€‚

![ASP.NET Core Empty Project](/blog/61/image-4.png)

### AppHostãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å‚ç…§å…ˆã‚’å®Ÿè£…ã™ã‚‹

`NextJSAspire.AppHost\Program.cs`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```cs
using Microsoft.Extensions.Hosting;

var builder = DistributedApplication.CreateBuilder(args);

var api = builder.AddProject<Projects.WebApi>("webapi");

var frontend = builder.AddNpmApp(name: "frontend", workingDirectory: "../frontend", scriptName: "dev")
    .WithHttpEndpoint(env: "PORT")
    .WithExternalHttpEndpoints()
    .WithReference(api);

if (builder.Environment.IsDevelopment() && builder.Configuration["DOTNET_LAUNCH_PROFILE"] == "https")
{
    frontend.WithEnvironment("NODE_TLS_REJECT_UNAUTHORIZED", "0");
}

builder.AddProject<Projects.ReverseProxy>("reverseproxy")
    .WithReference(frontend)
    .WithReference(api);

builder.Build().Run();
```

### Microsoft.Extensions.ServiceDiscovery.Yarpã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

1. Reverse Proxyãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®NuGetãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ç”»é¢ã‚’é–‹ãã¾ã™ã€‚
2. Microsoft.Extensions.ServiceDiscovery.Yarpã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

![NuGet Package Manager](/blog/61/image-6.png)

### Reverse Proxyã‚’å®Ÿè£…ã™ã‚‹

`ReverseProxy\Program.cs`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```cs
using Yarp.ReverseProxy.Configuration;

var builder = WebApplication.CreateBuilder(args);

// NOTE: ServiceDiscovery ã‚’æœ‰åŠ¹ã¨ã™ã‚‹ã€‚
// AppHost ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè£…ã—ãŸ Next.js ã¨ WebAPI ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å‚ç…§ã‚’ SerivceDiscovery ã§è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ãŒã€
// YARP ã®å ´åˆã¯ã€ã“ã‚Œã ã‘ã§ã¯ã€ServiceDiscovery ãŒã§ããªã„ã€‚
builder.AddServiceDefaults();

// NOTE: AddReverseProxy ã¯ Yarp.ReverseProxy ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ã‚‹ YARP ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«é©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
// Add ã—ãŸã‚‰ã€€Use ã™ã‚‹ã®ãŒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®åŸºæœ¬ãªã®ã§ã€Use ã‚’å¾Œã§å®Ÿè£…ã—ã¦ã„ã‚‹ï¼ˆä»Šå›ã¯ã€Mapï½ ãŒ Use ã«ç›¸å½“ã™ã‚‹ï¼‰ã€‚
builder.Services.AddReverseProxy()
    .LoadFromMemory(GetRoutes(), GetClusters())
    .AddServiceDiscoveryDestinationResolver();

var app = builder.Build();

app.MapDefaultEndpoints();

// NOTE: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®Use
app.MapReverseProxy();

app.Run();

// GetRoutes ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ¯ã‚Šåˆ†ã‘ã®ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©
RouteConfig[] GetRoutes()
{
    return
    [
        new RouteConfig
        {
            RouteId = "Route1",
            ClusterId = "default",
            Match = new RouteMatch { Path = "{**catch-all}" }
        },
        new RouteConfig
        {
            RouteId = "Route2",
            ClusterId = "api",
            Match = new RouteMatch { Path = "/api/{*any}" }
        },
    ];
}

// GetClusters ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ¯ã‚Šåˆ†ã‘å…ˆã®ãƒ‘ã‚¹ã‚’å®šç¾©
ClusterConfig[] GetClusters()
{
    return
    [
        new ClusterConfig
        {
            ClusterId = "default",
            Destinations = new Dictionary<string, DestinationConfig>
            {
                { "destination1", new DestinationConfig { Address = "http://frontend" } },
            }
        },
        new ClusterConfig
        {
            ClusterId = "api",
            Destinations = new Dictionary<string, DestinationConfig>
            {
                { "destination2", new DestinationConfig { Address =  "http://webapi", Host = "localhost" } },
            }
        },
    ];
}
```

### WebApiã«ã€Reverse Proxyã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹

`WebApi\Program.cs`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```cs
var builder = WebApplication.CreateBuilder(args);

builder.AddServiceDefaults();

// ---- è¿½åŠ  ã“ã“ã‹ã‚‰ ---- //
builder.Services.AddCors(x =>
{
    x.AddDefaultPolicy(policy =>
    {
        policy.AllowAnyHeader();
        policy.AllowAnyMethod();
        policy.AllowCredentials();
        policy.WithOrigins(new string[] { "https://localhost:7213", "http://localhost:5172" });
        // NOTE: å…¨ã¦ã® Origin ã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ã€ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰
        // policy.SetIsOriginAllowed(origin => true); 
    });
});
// ---- è¿½åŠ  ã“ã“ã¾ã§ ---- //

// Add services to the container.

var app = builder.Build();

// ---- è¿½åŠ  ã“ã“ã‹ã‚‰ ---- //
app.UseCors();  // CORSæœ‰åŠ¹ã®ãŸã‚ã«è¿½åŠ 
// ---- è¿½åŠ  ã“ã“ã¾ã§ ---- //

app.MapDefaultEndpoints();

...
```

### Next.jsã®CSRã‹ã‚‰WebAPIã®å‘¼ã³å‡ºã—ã‚’ä¿®æ­£

`frontend\src\app\client\page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
'use client'

import { useEffect, useState } from 'react';

const getData = async () => {
  const weatherData: Response = await fetch('/api/weatherforecast', { cache: 'no-cache' }) // <= ãƒ›ã‚¹ãƒˆåã‚’å‰Šé™¤

  ...
}
```

ã“ã‚Œã§ã€Reverse Proxyã‚’é€šã˜ã¦WebAPIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ReverseProxyã®ãƒªã‚½ãƒ¼ã‚¹ãŒå¢—ãˆã¦ã„ã‚‹ã®ã§ã€ReverseProxyã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åˆæœŸç”»é¢ã‚’è¡¨ç¤ºå¾Œã€`/client`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦WebAPIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—å¯èƒ½ã‹ç¢ºèªã—ã¾ã™ã€‚