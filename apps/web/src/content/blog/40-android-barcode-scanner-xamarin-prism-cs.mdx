---
title: C# | Xamarin Prism Androidç«¯æœ«ã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š
description: Xamarin Prism ã«ã‚ˆã‚Šã€Androidç«¯æœ«ã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰èª­ã¿è¾¼ã¿ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•
date: 2023-03-29
emoji: ğŸ·
tags: 
  - csharp
published: true
---

Xamarin Prism ã«ã‚ˆã‚Šã€Androidç«¯æœ«ã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰èª­ã¿è¾¼ã¿ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚    
ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šç”¨ã®ç”»é¢ã§èª­ã¿å–ã‚ŠãŒå®Œäº†ã—ãŸå¾Œã€èª­ã¿å–ã‚Šã—ãŸãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®å€¤ã‚’å‰ã®ç”»é¢ã«è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

Xamarin Prismã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã€ZXingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ä»¥ä¸‹ã¯ã€ZXingã‚’ä½¿ç”¨ã—ãŸãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã®å®Ÿè£…ä¾‹ã§ã™ã€‚  

## å®Ÿè£…æ‰‹é †

### 1. NuGetãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã€ZXingã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
NuGetãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚  

- ZXing.Net.Mobile
- ZXing.Net.Mobile.Forms

### 2. Androidã®MainActivity.csã«ã‚³ãƒ¼ãƒ‰è¿½åŠ 

æ¬¡ã«Androidã®MainActivity.csã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

â–¼MainActivity.cs 
```cs
[Activity(Theme = "@style/MainTheme",
            ConfigurationChanges = ConfigChanges.ScreenSize | ConfigChanges.Orientation | ConfigChanges.UiMode | ConfigChanges.ScreenLayout | ConfigChanges.SmallestScreenSize)]
public class MainActivity : global::Xamarin.Forms.Platform.Android.FormsAppCompatActivity
{
    protected override void OnCreate(Bundle savedInstanceState)
    {
        base.OnCreate(savedInstanceState);

        //// QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ç”¨ã«è¿½åŠ  ã“ã“ã‹ã‚‰
        ZXing.Net.Mobile.Forms.Android.Platform.Init();
        //// QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ç”¨ã«è¿½åŠ  ã“ã“ã¾ã§

        global::Xamarin.Forms.Forms.Init(this, savedInstanceState);

        LoadApplication(new App(new AndroidInitializer()));
    }

    public override void OnRequestPermissionsResult(int requestCode, string[] permissions, Android.Content.PM.Permission[] grantResults)
    {
        //// QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ç”¨ã«è¿½åŠ  ã“ã“ã‹ã‚‰
        global::ZXing.Net.Mobile.Android.PermissionsHandler.OnRequestPermissionsResult(requestCode, permissions, grantResults);
        //// QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ç”¨ã«è¿½åŠ  ã“ã“ã¾ã§

        base.OnRequestPermissionsResult(requestCode, permissions, grantResults);
    }
}

public class AndroidInitializer : IPlatformInitializer
{
    public void RegisterTypes(IContainerRegistry containerRegistry)
    {
        // Register any platform specific implementations
    }
}
```

### 3. Androidã®AndroidManifest.xmlã«ã‚³ãƒ¼ãƒ‰è¿½åŠ 

æ¬¡ã«Androidã®AndroidManifest.xmlã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚  
AndroidManifest.xmlã¯ã€Visual Studio ã§ã‚ã‚Œã°ã€Propertiesã®ç›´ä¸‹ã«å­˜åœ¨ã—ã¾ã™ã€‚  

â–¼AndroidManifest.xml
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" android:versionCode="1" android:versionName="1.0" package="com.companyname.appname">
	<uses-sdk android:minSdkVersion="21" android:targetSdkVersion="29" />

	<!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã«å¿…è¦ ã“ã“ã‹ã‚‰ -->
	<uses-permission android:name = "android.permission.CAMERA" />
	<uses-permission android:name = "android.permission.FLASHLIGHT" />
	<!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã«å¿…è¦ ã“ã“ã¾ã§ -->

	<application android:label="@string/app_name" android:icon="@mipmap/icon">
	</application>
</manifest>
```

### 4. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šç”»é¢ã‚’å®Ÿè£…

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€2ã¤ã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚

â– MainPage  
- ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã™ã‚‹ãƒšãƒ¼ã‚¸ï¼ˆScannerViewï¼‰ã«ç§»å‹•
- ScannerViewãƒšãƒ¼ã‚¸ã§èª­ã¿å–ã£ãŸãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®å€¤ã‚’ç”»é¢ã«è¡¨ç¤º

â– ScannerView  
- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå¾Œã€èª­ã¿å–ã£ãŸãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®å€¤ã‚’MainPageã«è¿”ã™

ã¾ãšã¯MainPageã®å®Ÿè£…ã§ã™ã€‚

â–¼MainPage.xml
```xml
<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Template.Views.MainPage"
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:prism="http://prismlibrary.com"
    prism:ViewModelLocator.AutowireViewModel="True">

    <Grid>
        <StackLayout>
            <Button Command="{Binding ScannerViewButton}" Text="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿é–‹å§‹" />

            <StackLayout Orientation="Horizontal">
                <Label Text="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿çµæœ: " />
                <Label Text="{Binding ScannedResultLabel}" />
            </StackLayout>
        </StackLayout>
    </Grid>
</ContentPage>
```

â–¼MainPageViewModel.cs
```cs
using Prism.Commands;
using Prism.Navigation;
using Prism.Services;
using Template.Views;

namespace Template.ViewModels
{
    /// <summary>
    /// QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
    /// </summary>
    public class MainPageViewModel : ViewModelBase
	{
        public Page003ViewModel(
            INavigationService navigationService)
            : base(navigationService)
        {
            ScannerViewButton = new DelegateCommand(ScannerViewButtonExecute);
        }

        public override void OnNavigatedTo(INavigationParameters parameters)
        {
            //// ScannerViewï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šç”»é¢ï¼‰ã§å–å¾—ã—ãŸãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®å€¤ã‚’å–å¾—
            var scannedResult = parameters[nameof(ScannerViewModel.ScannedResult)] as string;
            if (scannedResult == null)
            {
                ScannedResultLabel = string.Empty;
            }

            //// ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®å€¤ã‚’ç”»é¢ã®ãƒ©ãƒ™ãƒ«ã«åæ˜ 
            ScannedResultLabel = scannedResult;
        }

        private string _scannedResultLabel = string.Empty;
        public string ScannedResultLabel
        {
            get { return _scannedResultLabel; }
            set { SetProperty(ref _scannedResultLabel, value); }
        }

        public DelegateCommand ScannerViewButton { get; }

        private void ScannerViewButtonExecute()
        {
            //// ScannerViewï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šç”»é¢ï¼‰ã«é·ç§»
            base.NavigationService.NavigateAsync(nameof(ScannerView));
        }
    }
}
```

æ¬¡ã«ã€ScannerViewã®å®Ÿè£…ã§ã™ã€‚

â–¼ScannerView.xaml
```xml
<?xml version="1.0" encoding="utf-8" ?>
<zxing:ZXingScannerPage
    x:Class="Template.Views.ScannerView"
    xmlns="http://xamarin.com/schemas/2014/forms"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:Prism.Behaviors;assembly=Prism.Forms"
    xmlns:zxing="clr-namespace:ZXing.Net.Mobile.Forms;assembly=ZXing.Net.Mobile.Forms">

    <zxing:ZXingScannerPage.Behaviors>
        <behaviors:EventToCommandBehavior
            Command="{Binding ScanResultCommand}"
            EventArgsParameterPath="Result"
            EventName="ScanFinished" />
    </zxing:ZXingScannerPage.Behaviors>
</zxing:ZXingScannerPage>
```

â–¼ScannerView.xaml.cs
```cs
using System;
using Template.ExtendedEventArgs;
using ZXing.Net.Mobile.Forms;

namespace Template.Views
{
    public partial class ScannerView : ZXingScannerPage
    {
        public ScannerView()
        {
            InitializeComponent();

            DefaultOverlayTopText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã™";
            DefaultOverlayBottomText = "";

            this.OnScanResult += (result) =>
            {
                this.ScanFinished?.Invoke(this, new ScanFinishedEventArgs(result));
                this.IsScanning = false;
            };
        }

        //// ScanFinishedEventArgs ã¯åˆ¥ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ãŒå¿…è¦
        public event EventHandler<ScanFinishedEventArgs> ScanFinished;
    }
}
```

ScanFinishedEventArgs ã¯ã€Viewï¼ˆxamlï¼‰ã«å®Ÿè£…ã—ã¦ã„ã‚‹EventToCommandBehaviorã§ã€  
ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šçµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ViewModelã¸ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚¯ãƒ©ã‚¹ã§ã™ã€‚

ScanFinishedEventArgs ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

â–¼ScanFinishedEventArgs .cs
```cs
using System;

namespace Template.ExtendedEventArgs
{
    public class ScanFinishedEventArgs :EventArgs
    {
        public ScanFinishedEventArgs(ZXing.Result result)
        {
            Result = result;
        }

        public ZXing.Result Result { get; private set; }
    }
}
```

æœ€å¾Œã«ã€ViewModelã‚’å®Ÿè£…ã—ã¾ã™ã€‚

â–¼ScannerViewModel.cs
```cs
using Prism.Commands;
using Prism.Navigation;
using Prism.Services;

namespace Template.ViewModels
{
    public class ScannerViewModel : ViewModelBase
    {
        public ScannerViewModel(
            INavigationService navigationService,
            IPageDialogService pageDialogService,
            IDeviceService deviceService)
            : base(navigationService)
        {
            PageDialogService = pageDialogService;
            DeviceService = deviceService;

            ScanResultCommand = new DelegateCommand<ZXing.Result>(ScanResultCommandExecute);
        }

        public IPageDialogService PageDialogService { get; private set; }
        public IDeviceService DeviceService { get; private set; }

        /// <summary>
        /// ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³çµæœ
        /// </summary>
        public string ScannedResult { get; private set; }

        public DelegateCommand<ZXing.Result> ScanResultCommand { get; }

        private void ScanResultCommandExecute(ZXing.Result result)
        {
            DeviceService.BeginInvokeOnMainThread(() =>
            {
                ScannedResult = result.Text;

                var param = new NavigationParameters
                {
                    {nameof(ScannedResult), ScannedResult }
                };

                NavigationService.GoBackAsync(param);
                PageDialogService.DisplayAlertAsync("ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†", ScannedResult, "OK");
            });
        }
    }
}
```

ã“ã‚Œã‚‰ã®æ‰‹é †ã§ã€ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã—ãŸå€¤ã‚’å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã—ã¦è¡¨ç¤ºã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚  
ScannerViewã¯ã‚³ãƒ¼ãƒ‰ãƒ“ãƒã‚¤ãƒ³ãƒ‰ã«è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ä»–ã¯MVVMãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚  

## å‚è€ƒãƒªãƒ³ã‚¯

ã€Xamarin.Formsã€‘QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã‚’ã™ã‚‹æ–¹æ³•  
[https://takataka430.hatenablog.com/entry/2019/03/21/184259](https://takataka430.hatenablog.com/entry/2019/03/21/184259)

ã€Xamarin 002ã€‘QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Zxing.Net.Mobile.Forms ã‚’ Prism ã£ã½ãä½¿ã£ã¦ã¿ãŸ  
[https://johnny06r.hatenablog.com/entry/2018/08/29/012710](https://johnny06r.hatenablog.com/entry/2018/08/29/012710)
